<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜å½±æ•¸ä½å½±åƒ - ç·šä¸Šæ²–å°</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; padding: 10px; margin: 0; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); max-width: 500px; margin: auto; }
        .photo-item { display: flex; align-items: center; background: #fff; padding: 10px; margin: 10px 0; border-radius: 10px; border: 1px solid #eee; }
        .photo-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; margin-right: 15px; }
        .qty-controls { display: flex; align-items: center; gap: 12px; }
        .btn-qty { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #007bff; background: #fff; color: #007bff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-qty:active { background: #007bff; color: white; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        #totalBox { background: #fff3cd; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #ffeeba; }
        #submitBtn { width: 100%; padding: 16px; background: #28a745; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        #submitBtn:disabled { background: #ccc; }
    </style>
</head>
<body>
<div class="card">
    <h2 style="text-align: center; color: #333;">ğŸ“¸ æ˜å½±æ•¸ä½å½±åƒ</h2>
    
    <label>1. é¸æ“‡æ²–å°è¦æ ¼</label>
    <select id="sizeSelect"><option>è¼‰å…¥åƒ¹æ ¼ä¸­...</option></select>
    
    <label>2. é¸æ“‡ç…§ç‰‡ä¸¦èª¿æ•´æ•¸é‡</label>
    <input type="file" id="fileInput" multiple accept="image/*">
    <div id="photoList"></div>

    <label>3. å®¢æˆ¶é€£çµ¡é›»è©±</label>
    <input type="tel" id="phoneInput" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">

    <div id="totalBox">è«‹å…ˆé¸æ“‡ç…§ç‰‡èˆ‡è¦æ ¼</div>
    
    <button id="submitBtn">ç¢ºèªé€å‡ºè¨‚å–®</button>
</div>

<script>
    let prices = [];
    let selectedData = []; 
    const sizeSelect = document.getElementById('sizeSelect');
    const fileInput = document.getElementById('fileInput');
    const photoList = document.getElementById('photoList');
    const totalBox = document.getElementById('totalBox');

    async function loadData() {
        const res = await fetch('/prices');
        prices = await res.json();
        sizeSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
        prices.forEach(p => {
            let opt = document.createElement('option');
            opt.value = p.name;
            opt.textContent = `${p.name} (åŸåƒ¹${p.basePrice}å…ƒ)`;
            sizeSelect.appendChild(opt);
        });
    }

    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        selectedData = files.map(file => ({ file, qty: 1 }));
        render();
    };

    function render() {
        photoList.innerHTML = '';
        selectedData.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <img src="${URL.createObjectURL(item.file)}">
                <div>
                    <div class="qty-controls">
                        <button class="btn-qty" onclick="updateQty(${i},-1)">-</button>
                        <b id="qty-${i}">${item.qty}</b>
                        <button class="btn-qty" onclick="updateQty(${i},1)">+</button>
                    </div>
                </div>
            `;
            photoList.appendChild(div);
        });
        calculate();
    }

    window.updateQty = (i, delta) => {
        selectedData[i].qty = Math.max(1, selectedData[i].qty + delta);
        document.getElementById(`qty-${i}`).textContent = selectedData[i].qty;
        calculate();
    };

    function calculate() {
        const item = prices.find(p => p.name === sizeSelect.value);
        const totalQty = selectedData.reduce((s, p) => s + p.qty, 0);
        
        if (!item || totalQty === 0) {
            totalBox.innerHTML = "è«‹é¸å–ç…§ç‰‡èˆ‡è¦æ ¼";
            return;
        }

        let up = item.basePrice;
        if (item.limit2 > 0 && totalQty >= item.limit2) up = item.special2;
        else if (item.limit1 > 0 && totalQty >= item.limit1) up = item.special1;

        const totalMoney = Math.round(up * totalQty); // å››æ¨äº”å…¥
        totalBox.innerHTML = `
            <b>è¨ˆè²»æ˜ç´°ï¼š</b><br>
            å–®åƒ¹ï¼š${up} å…ƒ | ç¸½å¼µæ•¸ï¼š${totalQty} å¼µ<br>
            <span style="font-size: 20px; color: #d9534f;">ç¸½è¨ˆï¼š${totalMoney} å…ƒ</span>
        `;
        window.orderFinal = { totalMoney, totalQty };
    }

    sizeSelect.onchange = calculate;

    document.getElementById('submitBtn').onclick = async () => {
        const phone = document.getElementById('phoneInput').value;
        if (!phone || !sizeSelect.value || selectedData.length === 0) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.textContent = 'ä¸Šå‚³ä¸­...';

        const fd = new FormData();
        fd.append('phone', phone);
        fd.append('size', sizeSelect.value);
        fd.append('total', window.orderFinal.totalMoney);
        fd.append('count', window.orderFinal.totalQty);
        selectedData.forEach(d => fd.append('photos', d.file));

        try {
            await fetch('/upload', { method: 'POST', body: fd });
            alert('è¨‚å–®ä¸Šå‚³æˆåŠŸï¼');
            location.reload();
        } catch (e) {
            alert('ä¸Šå‚³å¤±æ•—');
            btn.disabled = false;
        }
    };

    loadData();
</script>
</body>
</html>